{% extends "base.html" %}

{% block title %}Lista de Estoque{% endblock %}

{% block content %}

<h3 class="text-center mb-4">Produtos</h3>

<div class="card-dark shadow-soft p-3">

    <div class="d-flex justify-content-between align-items-center mb-3">

        <form method="GET" action="{% url 'products_view' %}" id="status-filter-form">
            <select class="form-select custom-select-dark w-auto" name="status"
                onchange="document.getElementById('status-filter-form').submit();">

                <option value="TODOS" {% if selected_status == 'TODOS' or selected_status is None %} selected {% endif %}>
                    Todos</option>

                {% for code, display_name in status_choices %}
                <option value="{{ code }}" {% if selected_status|safe == code|safe %} selected {% endif %}>
                    {{display_name}}</option>
                {% endfor %}
            </select>
        </form>

        <a href="{% url 'create_view' %}" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Cadastrar
        </a>
    </div>

    <div class="table-responsive">
        <table class="table table-dark-custom table-hover text-center bg-transparent table-striped table-custom-border">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Categoria</th>
                    <th>Quantidade</th>
                    <th>Valor de compra</th>
                    <th>Lucro</th>
                    <th>Ações</th>
                </tr>
            </thead>

            <tbody>
                {% for product in products_list %}
                <tr>
                    <td class="fw-semibold"><a class="text-white" style="text-decoration: none;"
                            href="{% url 'edit_view' product.id %}">{{product.name}}</a></td>
                    <td>{{product.category}}</td>
                    <td>{{product.quantity}}</td>
                    <td>R$ {{product.cost|floatformat:2}}</td>
                    <td class="profit-cell">R$ {{product.profit|floatformat:2}}</td>
                    <td>
                        <div class="d-flex justify-content-center">
                            <a href="{% url 'edit_view' product.id %}"><button onclick="delete_alert()"
                                    class="btn btn-sm edit-icon">
                                    <i class="bi bi-pen"></i>
                                </button></a>

                            <form action="{% url 'delete_view' product.id %}" method="POST"
                                onsubmit="return confirm('Tem certeza que deseja excluir este item? Esta ação é irreversível.');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm">
                                    <i class="bi bi-trash delete-icon"></i>
                                </button>
                            </form>
                        </div>

                    </td>
                </tr>
                {% endfor %}
                <script>
                    document.addEventListener('DOMContentLoaded', (event) => {

                        const profit_cells = document.getElementsByClassName('profit-cell');

                        Array.from(profit_cells).forEach(sale_value_element => {

                            const raw_value = sale_value_element.textContent;

                            const cleaned_value = raw_value.replace(/[^\d,\-]/g, '').replace(',', '.');

                            const sale_value = parseFloat(cleaned_value);

                            if (!isNaN(sale_value)) {
                                if (sale_value > 0) {
                                    sale_value_element.style.color = '#22C55E';
                                } else if (sale_value < 0) {
                                    sale_value_element.style.color = 'red';
                                } else
                                    sale_value_element.style.color = 'yellow';
                            }
                        });
                    });
                </script>
            </tbody>
        </table>
    </div>

</div>

{% endblock %}